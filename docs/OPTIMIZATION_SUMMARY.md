# Bybit API优化总结

## 已完成的优化

### 1. 代码优化 ✅

#### 1.1 速率限制器配置优化
**文件**: `shared/exchange/bybit.py`

**优化内容**:
- 市场数据预算：从10 RPS降至2 RPS（更符合20个交易对的实际情况）
- 区分订单创建和查询：创建2 RPS，查询5 RPS（符合Bybit实际限制）
- 账户查询：保持3 RPS（合理）

**效果**: 减少API请求压力，降低速率限制风险

#### 1.2 订单状态轮询优化
**文件**: `shared/exchange/bybit.py`

**优化内容**:
- 添加初始延迟（0.3秒）：订单创建后需要处理时间
- 实现指数退避：0.3s → 0.45s → 0.675s → 1.0s
- 订单成交后立即退出：避免不必要的后续查询

**效果**: 减少订单状态查询的API请求约50%

#### 1.3 closed-pnl查询优化
**文件**: `shared/exchange/bybit.py`

**优化内容**:
- 减少查询窗口：从15分钟降至10分钟
- 增加查询间隔：从0.3秒增至0.5秒
- 限制最大查询次数：最多5次，避免无限循环

**效果**: 减少账户查询API请求

#### 1.4 响应头解析和监控
**文件**: `shared/exchange/bybit.py`

**优化内容**:
- 解析Bybit速率限制响应头（X-Bapi-Limit-*）
- 接近限制时记录警告日志
- 帮助提前发现速率限制问题

**效果**: 更好的监控和预警

#### 1.5 错误处理优化
**文件**: `shared/exchange/bybit.py`

**优化内容**:
- 区分retCode=10006的两种情况（速率限制 vs API密钥错误）
- 速率限制错误正确抛出RateLimitError，触发退避
- 详细的错误信息和建议

**效果**: 更准确的错误处理和恢复

### 2. 数据同步优化 ✅

#### 2.1 增加同步间隔
**文件**: `services/data_syncer/main.py`

**优化内容**:
- 主循环间隔：从10秒增至30秒（可配置，默认30秒）
- 交易对间延迟：0.5秒（可配置）

**效果**: 20个交易对从每分钟120次请求降至约40次（减少67%）

#### 2.2 可配置参数
**文件**: `shared/config/loader.py`

**新增参数**:
- `DATA_SYNC_LOOP_INTERVAL_SECONDS`: 主循环间隔（默认30秒）
- `DATA_SYNC_SYMBOL_DELAY_SECONDS`: 交易对间延迟（默认0.5秒）

**效果**: 可以根据实际情况灵活调整

### 3. 策略引擎优化 ✅

#### 3.1 添加日志记录
**文件**: `services/strategy_engine/main.py`

**优化内容**:
- 当Setup B条件不满足时，记录详细原因
- 帮助诊断为什么没有下单

**效果**: 更好的可观测性和问题诊断

---

## 参数配置建议

### 立即调整（高优先级）

```bash
# .env文件

# 1. 降低策略阈值，增加交易机会
SETUP_B_ADX_MIN=18              # 从20降至18
SETUP_B_VOL_RATIO_MIN=1.3       # 从1.5降至1.3
SETUP_B_AI_SCORE_MIN=50         # 从55降至50

# 2. 增加数据同步间隔（进一步减少API请求）
DATA_SYNC_LOOP_INTERVAL_SECONDS=60  # 从30增加到60秒

# 3. 必须设置账户资金
ACCOUNT_EQUITY_USDT=你的实际资金  # 例如：1000, 5000等

# 4. 可选：增加并发持仓数（如果资金充足）
MAX_CONCURRENT_POSITIONS=5      # 从3增加到5
```

### 参数说明

| 参数 | 当前值 | 建议值 | 原因 |
|------|--------|--------|------|
| `SETUP_B_ADX_MIN` | 20 | 18 | 降低阈值增加交易机会 |
| `SETUP_B_VOL_RATIO_MIN` | 1.5 | 1.3 | 降低成交量要求 |
| `SETUP_B_AI_SCORE_MIN` | 55 | 50 | 降低AI评分要求 |
| `DATA_SYNC_LOOP_INTERVAL_SECONDS` | 30 | 60 | 进一步减少API请求 |
| `ACCOUNT_EQUITY_USDT` | 500 | **必须设置** | 用于风险计算 |

---

## Bybit API限制规则

### HTTP REST限制
- **IP级别**: 每5秒最多600次请求
- **UID级别**: 基于API Key的滚动窗口限制
- **Endpoint级别**: 
  - 订单创建：10-20次/秒
  - 订单查询：50次/秒
  - 市场数据：相对宽松

### WebSocket限制
- 每个IP 5分钟内最多500个连接
- 支持公共频道（无需认证）
- 支持kline/ticker/orderbook实时推送

### 关键错误码
- **retCode=10006**: "Too many visits! Exceeded the API Rate Limit"
- **retCode=10004**: 签名错误（已解决）

---

## 优化效果预期

### API请求频率
- **优化前**: 20交易对 × 6次/分钟 = 120次/分钟
- **优化后**: 20交易对 × 1次/分钟 = 20次/分钟（减少83%）

### 速率限制错误
- **优化前**: 频繁触发retCode=10006
- **优化后**: 预期大幅减少，接近0

### 交易机会
- **优化前**: 可能因为条件太严格而没有交易
- **优化后**: 降低阈值后，预期交易频率增加

---

## 下一步建议

### 短期（1-2周）
1. ✅ 应用参数调整
2. ✅ 监控API请求频率
3. ✅ 观察交易执行情况
4. ✅ 根据实际情况微调参数

### 中期（1-2月）
1. 实现WebSocket市场数据订阅
2. 分离API Key（市场数据 vs 交易操作）
3. 添加更详细的监控和告警

### 长期（3-6月）
1. 实现请求队列和智能调度
2. 添加自适应速率调整
3. 实现多交易所支持（如果需要）

---

## 监控指标

### 关键指标
1. **API请求频率**: 每分钟总请求数
2. **速率限制错误**: retCode=10006频率
3. **交易执行**: 下单成功率、成交时间
4. **策略表现**: 交易频率、盈亏比

### 告警阈值
- API速率限制错误 > 5次/小时
- 数据延迟 > 5分钟
- 连续3个tick没有交易机会

---

## 文档索引

1. **详细分析**: `docs/BYBIT_OPTIMIZATION_ANALYSIS.md`
2. **参数建议**: `docs/PARAMETER_RECOMMENDATIONS.md`
3. **数据同步优化**: `docs/OPTIMIZE_DATA_SYNCER.md`
4. **诊断指南**: `tools/DIAGNOSIS_GUIDE.md`

---

## 重要提醒

1. ⚠️ **必须设置ACCOUNT_EQUITY_USDT**: 根据实际账户资金设置
2. ⚠️ **逐步调整参数**: 不要一次性大幅调整所有参数
3. ⚠️ **监控API请求**: 确保不超过Bybit限制
4. ⚠️ **观察交易效果**: 调整参数后观察1-2天再决定是否继续调整

---

## 技术支持

如果遇到问题：
1. 查看日志中的错误信息
2. 检查API请求频率
3. 验证参数配置
4. 参考诊断指南：`tools/DIAGNOSIS_GUIDE.md`
