# 历史回测分析指南

## 概述

本项目提供了两个回测工具：

1. **`backtest.py`** - 基础回测工具：仅分析信号数量
2. **`backtest_with_pnl.py`** - 增强回测工具：完整交易模拟和盈利分析 ⭐推荐

## 快速开始

### 1. 基础回测（仅信号统计）

```bash
cd /Users/jeff/Project/trading_bot
python3 -m scripts.trading_test_tool.backtest --symbol BTCUSDT --months 6
```

### 2. 完整回测（信号 + 盈利分析）⭐

```bash
cd /Users/jeff/Project/trading_bot
python3 -m scripts.trading_test_tool.backtest_with_pnl \
    --symbol BTCUSDT \
    --months 6 \
    --equity 1000 \
    --fee-rate 0.0004 \
    --slippage-rate 0.001
```

## 参数说明

### `backtest_with_pnl.py` 参数

- `--symbol`: 交易对（默认: BTCUSDT）
- `--months`: 回测月数（默认: 6）
- `--interval`: K线周期分钟数（默认: 15，从配置读取）
- `--equity`: 初始资金USDT（默认: 1000）
- `--fee-rate`: 手续费率（默认: 0.0004 = 0.04%）
- `--slippage-rate`: 滑点率（默认: 0.001 = 0.1%）

## 回测流程

### 步骤1: 数据准备
- 检查数据库中的历史K线数据完整性
- 如果数据不足，从交易所（Bybit/Binance）获取历史K线
- 计算并存储技术指标特征（EMA、RSI、ADX等）

### 步骤2: 信号识别
- 遍历所有K线，识别满足 Setup B 条件的买入信号
- Setup B 条件包括：
  - ADX >= 阈值 且 +DI > -DI
  - Squeeze release（前一根squeeze_status==1，当前==0）
  - Momentum flip（mom10从负转正）
  - Volume ratio >= 阈值
  - AI score >= 阈值（回测中设为50）

### 步骤3: 交易模拟
对每个信号模拟完整交易流程：

1. **开仓计算**
   - 根据 robot_score 计算杠杆（10-20倍）
   - 根据 min_order_usdt 和杠杆计算数量
   - 应用滑点（买入时向上滑点）
   - 计算实际保证金和名义价值
   - 风控检查（risk_budget）

2. **持仓管理**
   - 设置止损价：`entry_price * (1 - stop_dist_pct)`
   - 设置止盈价：`entry_price * (1 + stop_dist_pct * 2)`（可选）
   - 遍历后续K线，检查止损/止盈触发

3. **平仓计算**
   - 根据触发条件确定平仓价
   - 应用滑点（卖出时向下滑点）
   - 计算盈亏（考虑杠杆）
   - 计算手续费（开仓+平仓）
   - 计算净盈亏

### 步骤4: 统计分析
计算以下指标：

**基础统计**
- 总信号数、总交易次数
- 盈利交易数、亏损交易数
- 胜率（Win Rate）

**盈亏统计**
- 总盈亏（未扣手续费）
- 总手续费
- 净盈亏（扣除手续费）
- 总收益率
- 平均盈利、平均亏损
- 盈亏比（Profit Factor）
- 最大单笔盈利、最大单笔亏损

**风险指标**
- 最大回撤（Max Drawdown）
- 夏普比率（Sharpe Ratio）
- 平均持仓时间

**退出原因统计**
- STOP_LOSS（止损）
- TAKE_PROFIT（止盈）
- END_OF_DATA（数据结束）
- RISK_REJECT（风控拒绝）

### 步骤5: 报告生成
生成详细的文本报告和JSON结果文件

## 盈利计算公式

### 杠杆交易盈亏计算

```
价格变化百分比 = (平仓价 - 开仓价) / 开仓价
盈亏（USDT）= 价格变化百分比 × 杠杆 × 保证金
盈亏百分比（相对于保证金）= 价格变化百分比 × 杠杆 × 100%
盈亏百分比（相对于名义价值）= 价格变化百分比 × 100%
```

### 手续费计算

```
开仓手续费 = 名义价值 × 手续费率
平仓手续费 = 数量 × 平仓价 × 手续费率
总手续费 = 开仓手续费 + 平仓手续费
净盈亏 = 盈亏 - 总手续费
```

### 示例

假设：
- 开仓价：$50,000
- 平仓价：$51,000（上涨2%）
- 杠杆：15倍
- 保证金：$100 USDT
- 手续费率：0.04%

计算：
```
价格变化 = (51000 - 50000) / 50000 = 2%
盈亏 = 2% × 15 × $100 = $30 USDT
名义价值 = $100 × 15 = $1,500
开仓手续费 = $1,500 × 0.04% = $0.6
平仓手续费 = $1,500 × 0.04% = $0.6
总手续费 = $1.2
净盈亏 = $30 - $1.2 = $28.8 USDT
```

## 输出文件

回测完成后会生成：

1. **控制台报告**：详细的文本报告
2. **JSON结果文件**：`backtest_results_{symbol}_{timestamp}.json`
   - 包含所有信号、交易、统计数据的完整信息
   - 可用于进一步分析和可视化

## 专业建议

### 1. 回测参数设置

**保守设置**（更接近实际）
- 手续费率：0.0004（0.04%）
- 滑点率：0.001（0.1%）
- 初始资金：与实际账户资金一致

**激进设置**（理想情况）
- 手续费率：0.0002（0.02%）
- 滑点率：0.0005（0.05%）

### 2. 回测时间范围

- **短期回测**（1-3个月）：验证策略近期表现
- **中期回测**（3-6个月）：评估策略稳定性
- **长期回测**（6-12个月）：全面评估策略有效性

### 3. 关键指标解读

**胜率（Win Rate）**
- > 50%：策略有优势
- 40-50%：需要高盈亏比支撑
- < 40%：策略可能有问题

**盈亏比（Profit Factor）**
- > 1.5：优秀
- 1.2-1.5：良好
- 1.0-1.2：一般
- < 1.0：亏损策略

**最大回撤（Max Drawdown）**
- < 10%：风险控制良好
- 10-20%：可接受
- > 20%：风险较高

**夏普比率（Sharpe Ratio）**
- > 1.0：优秀
- 0.5-1.0：良好
- < 0.5：一般

### 4. 注意事项

1. **未来数据泄露**：确保只使用信号出现时的历史数据
2. **滑点影响**：高频交易策略受滑点影响更大
3. **市场环境**：不同市场环境（牛市/熊市/震荡）表现可能差异很大
4. **过拟合风险**：避免过度优化参数
5. **资金管理**：回测中假设单币对单仓位，实际可能有多币对并发

### 5. 优化方向

1. **参数优化**：测试不同的止损比例、止盈比例
2. **多币对回测**：测试多币对组合的表现
3. **资金曲线分析**：分析资金曲线的平滑度
4. **时间段分析**：分析不同时间段的表现差异
5. **风险调整收益**：关注风险调整后的收益指标

## 示例输出

```
====================================================================================================
历史回测报告 - Setup B 策略
====================================================================================================

交易对: BTCUSDT
K线周期: 15 分钟
回测时间范围: 2025-07-20 00:00:00 ~ 2026-01-20 00:00:00
回测天数: 180.0 天
总K线数量: 17280
初始资金: $1,000.00 USDT

----------------------------------------------------------------------------------------------------
信号统计
----------------------------------------------------------------------------------------------------
Setup B 信号数量: 45
信号频率: 0.26% (45/17280)

----------------------------------------------------------------------------------------------------
交易统计
----------------------------------------------------------------------------------------------------
总交易次数: 45
盈利交易: 28 (62.22%)
亏损交易: 17 (37.78%)
平均持仓时间: 12.5 小时

----------------------------------------------------------------------------------------------------
盈亏分析
----------------------------------------------------------------------------------------------------
总盈亏（未扣手续费）: $1,250.00 USDT
总手续费: $45.00 USDT
净盈亏（扣除手续费）: $1,205.00 USDT
总收益率: 120.50%
最终资金: $2,205.00 USDT

平均盈利: $85.50 USDT
平均亏损: -$42.30 USDT
盈亏比（Profit Factor）: 2.02
最大单笔盈利: $320.00 USDT
最大单笔亏损: -$150.00 USDT

----------------------------------------------------------------------------------------------------
风险指标
----------------------------------------------------------------------------------------------------
最大回撤: $180.00 USDT (18.00%)
夏普比率: 1.5234

----------------------------------------------------------------------------------------------------
退出原因统计
----------------------------------------------------------------------------------------------------
  STOP_LOSS: 17 次 (37.8%)
  TAKE_PROFIT: 20 次 (44.4%)
  END_OF_DATA: 8 次 (17.8%)
```

## 常见问题

### Q1: 为什么有些信号没有产生交易？

可能原因：
- 风控拒绝（risk_budget超限）
- 数量太小（qty <= 0）
- 资金不足

### Q2: 如何提高回测准确性？

1. 使用更保守的滑点和手续费设置
2. 增加回测时间范围
3. 考虑市场流动性影响
4. 添加更多市场环境分析

### Q3: 回测结果很好，但实盘表现不佳？

可能原因：
1. 过拟合：参数过度优化
2. 市场环境变化：回测期间的市场环境与实盘不同
3. 执行差异：实盘执行与回测假设不一致
4. 心理因素：实盘交易的心理压力

## 下一步

1. **参数优化**：测试不同的止损/止盈比例
2. **多币对回测**：扩展到多个交易对
3. **可视化分析**：使用JSON结果文件生成图表
4. **实盘验证**：小资金实盘验证回测结果

## 技术支持

如有问题，请查看：
- 代码注释
- 日志输出
- JSON结果文件中的详细信息
